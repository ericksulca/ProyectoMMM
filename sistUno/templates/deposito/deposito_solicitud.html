{% extends 'base/base_login.html' %}
{% load staticfiles %}


{% block breadcrumb %}
<ol class="breadcrumb">
  <li class="breadcrumb-item">
    <a href="{% url 'usuario:principal' %}">Principal</a>
  </li>
  <li class="breadcrumb-item active">
    <a href="{% url 'deposito:index' %}"></a>Dar ayuda
  </li>
  <!-- <li class="breadcrumb-item">
    <a href="{% url 'deposito:deposito_usuario' %}">Nuevo deposito</a>
  </li>
  <li class="breadcrumb-item active">
    <a href="{% url 'deposito:deposito_solicitud' %}">Respuesta a prestamos</a>
  </li> -->
</ol>
{% endblock %}

{% block content %}

<h1>Dar Ayuda</h1>
<div class="" id="tableField">



<!-- {%for a in lista_receptores%}
{{a}}
{%endfor%} -->
<!-- <hr> -->
{% if deposito_realizar %}

<p class="text-primary">No puede realizar más operaciones hasta realizar el deposito a las siguientes cuentas bancarias.</p>
<p class="text-danger">El depósito debe realizarse como máximo 48 horas después de la fecha correspondiente.</p>

  <table class="table table-bordered table-hover small" id="dataTable">
    <thead>
      <tr class="text-center">
        <td>FECHA</td>
        <td>NOMBRE COMPLETO</td>
        <td>ENTIDAD BANCARIA</td>
        <td>NÚMERO DE CUENTA</td>
        <td>MONTO (S/)</td>
        <td>CONFIRMAR</td>
      </tr>
    </thead>
    <tfoot>
      <tr class="text-center">
        <td>FECHA</td>
        <td>NOMBRE COMPLETO</td>
        <td>ENTIDAD BANCARIA</td>
        <td>NÚMERO DE CUENTA</td>
        <td>MONTO (S/)</td>
        <td>CONFIRMAR</td>
      </tr>
    </tfoot>
    <tbody>
      {%for m in deposito_realizar%}
      <tr>
        <td class="text-center">{{m.fecha_registro|date:"d-m-Y"}}</td>
        <td class="text-left">{{m.id_emisor.apellido_paterno}} {{m.id_emisor.apellido_materno}} {{m.id_emisor.nombres}}</td>
        <td class="text-center">{{m.id_emisor.entidad_bancaria}}</td>
        <td class="text-center">{{m.id_emisor.numero_cuenta}}</td>
        <td class="text-right">{{m.monto}}.00</td>
        <td class="text-center"><a type="button" class="btn btn-primary btn-sm" name="button" onclick="confirmarDepositoModal({{m.id}},{{m.id_emisor.id}},{{m.monto}})"> Confirmar </a> </td>
      </tr>

      {%endfor%}
    </tbody>
  </table>

{%else%}

  {%ifequal usuario.depositos_pendientes 0%}
  {%ifequal monto None%}
  <label class="text-primary">El monto máximo requerido por todos los usuarios es de S/ 0 </label>
  <input type="hidden" id="id_monto" value="0" disabled class="form-control">
  {%else%}
  <label class="text-primary">El monto máximo requerido por todos los usuarios es de S/ {{monto}}</label>
  <input type="hidden" id="id_monto" value="{{monto}}" disabled class="form-control">
  {%endifequal%}
  <form  method="POST" id="form-solicitud">
    <!-- action="{% url 'deposito:deposito_solicitud' %}" -->
      {% csrf_token %}
      <label for="monto">Monto</label>
      <input type="number" id="monto" class="form-control-p" name="monto" placeholder="0.00" step="0.01" required>
      <!-- <input type="text" name="id_emisor" value=""> -->
      <input type="submit" value="Guardar" class="btn btn-primary" id="id_submit">
      <div class="alert-danger" id="msg">

      </div>
  </form>
  {%else%}
  <p class="text-primary">Debe esperar la confirmación por parte de los solicitantes para que pueda seguir realizando operaciones.</p>
  {% endifequal %}


{% endif %}

</div>

<!-- {{usuario.dni}} -->

<!-- <p>NOTIFICACIONES</p> -->
<!-- {%for notificacion in notificaciones%}
<p>{{notificacion.id}}</p><br>
{% endfor %} -->

<!-- Modal de confirmacion-->
<div class="modal fade" id="confirmacionModal" tabindex="-1" role="dialog" aria-labelledby="confirmacionModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmacionModalLabel"><b>Confirmación de depósito</b></h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body">La confirmación se realiza luego de depositar el dinero en la cuenta bancaria correspondiente, si ya lo hizo de click en "Aceptar".
        <input type="hidden" name="" id="id_confirmacion_modal" value="">
        <input type="hidden" name="" id="dni_receptor_confirmacion_modal" value="">
        <input type="hidden" name="" id="monto_confirmacion_modal" value="">
      </div>
      <div class="modal-footer">


        <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" onclick="confirmarDeposito()">Aceptar</button>

      </div>
    </div>
  </div>
</div>
<!-- Fin modal de confirmacion -->


{% endblock %}

{% block scripts %}
<div id="scripts">
<script>


// $('#form-solicitud')[0].reset();

$("#monto").focus();

$("#monto").keyup(function(){
  var monto_ingresado=parseFloat($("#monto").val());
  var monto_maximo=parseFloat($("#id_monto").val());

  // console.log(monto_ingresado+' '+monto_maximo);

  if(monto_ingresado>monto_maximo){

    $('#id_submit').attr('disabled','true');
    $('#msg').html('El monto ingresado es mayor al monto solicitado');

  }else{
    $('#id_submit').removeAttr('disabled');
    $('#msg').html('');
  }
})


function confirmarDepositoModal(id,dni_receptor,monto){

  $("#confirmacionModal").modal("show");
  $("#id_confirmacion_modal").val(id);
  $("#dni_receptor_confirmacion_modal").val(dni_receptor);
  $("#monto_confirmacion_modal").val(monto);
}

function confirmarDeposito(){
  $("#confirmacionModal").modal("hide");
  var id=$("#id_confirmacion_modal").val();
  var dni_receptor=$("#dni_receptor_confirmacion_modal").val();

  $.ajax({
    type: 'get',
    url: "/Deposito/confirmar_deposito/"+id+"/"+dni_receptor,
    beforeSend:function(objeto){
                $('#div_carga').css({display:'block'});
    },
    success:function(){

      $("#tableField").load(" #tableField>*","");
      $("#scripts").load(" #scripts>*","");

    },
    complete:function(){
      $('#div_carga').css('display','none');
    }
  })
}



</script>
</div>
{% endblock %}
