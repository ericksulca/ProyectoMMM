{% extends 'base/base_login.html'%}
{% load staticfiles %}

{%block content%}

<h1>Página principal usuario</h1>

<!-- Area Chart Example-->
<div class="card mb-3">
  <div class="card-header">
    <i class="fas fa-chart-area"></i>
    Saldo reciente</div>
  <div class="card-body">
    <canvas id="MyChart" width="100%" height="30"></canvas>
  </div>
  <div class="card-footer small text-muted">Updated yesterday at 11:59 PM</div>
</div>

<!-- DataTables Example -->
<div class="card mb-3">
  <div class="card-header">
    <i class="fas fa-table"></i>
    Detalle de operaciones en la cuenta de {% if user is None %}Sesion no iniciada {% else %} {{ user.username }} {% endif %}</div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>DNI emisor</th>
            <th>Operacion</th>
            <th>Monto</th>
            <th>Saldo inicial</th>
            <th>Saldo final</th>
          </tr>
        </thead>
        <tfoot>
        </tfoot>
      </table>
    </div>
  </div>
  <div class="card-footer small text-muted">Actualizado ayer 11:59 PM</div>
</div>

{%endblock%}

{% block scripts %}

<script>

  $(document).ready(function() {
    detalles_operaciones();
  });

  var detalles_operaciones = function() {
    var table = $('#dataTable').DataTable({
      "processing": true,
      "ajax": {
        method: "GET",
        url: "/Deposito/operaciones/listar/",
        "dataSrc": "",
      },
      "columns":[
        {"data": "fields.fecha"},
        {"data": "fields.usuario_emisor"},
        {"data": "fields.tipo_movimiento"},
        {"data": "fields.monto"},
        {"data": "fields.saldo_inicial"},
        {"data": "fields.saldo_final"}
      ]
    });
  }

var fecha = function(mes) {
    var meses = {
        '01': 'Enero',
        '02': 'Febrero',
        '03': 'Marzo',
        '04': 'Abril',
        '05': 'Mayo',
        '06': 'Junio',
        '07': 'Julio',
        '08': 'Agosto',
        '09': 'Setiembre',
        '10': 'Octubre',
        '11': 'Noviembre',
        '12': 'Diciembre',
    };
    return meses[mes] || 'Mes';
}

var arrTiempoAFecha = function(fecha) {
    const partes = fecha.split(/[-, T, :]/);
    return partes;
}


window.onload = function() {
  var fechas = [];
  var saldos = [];
  var ctx = document.getElementById("MyChart");
  $.ajax({
    method: 'GET',
    url: '/Deposito/operaciones/listar-chart/',
    success: function(data) {
      console.log(labels);
      data.forEach(element => {
        fechas.push(element.fields.fecha);
        saldos.push(element.fields.saldo_final);
      });
      // console.log(fechas);
      // console.log(saldos);
      // console.log(ctx);            
      var respuesta = [];      
      var labels = [];

      fechas.forEach(function(element, index, array) {
          res = arrTiempoAFecha(element);
          respuesta.push(res);
      });

      respuesta.forEach(function(element, index, array) {
          año = element[0];
          mes = fecha(element[1]) + ' ';
          dia = element[2] + ' ';
          label = dia + 'de ' + mes + 'del ' + año;
          labels.push(label);
      });

      var myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Saldo',
                data: saldos,
                borderColor: 'rgb(28, 106, 216)',
                backgroundColor: 'rgba(28, 106, 216, 0.8)',
                borderWidth: 1
            }],
        },
        options: {
            title: {
              display: true,
              text: 'Saldo reciente',
            },
            tooltips: {
              mode: 'index',
              intersect: false,
            },
            hover: {
              mode: 'nearest',
              intersect: true,
            },
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero:true
                    }
                }]
            }
        }
      });
    },
  error: function(error_data) {
      console.log("error");
      console.log(error_data)
  }
});

}
  
</script>

{% endblock %}
