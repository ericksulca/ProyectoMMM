{% extends 'base/base.html' %} {% load staticfiles%}{% block header %} {% endblock %} {% block content %}
<div class="container">
    <div class="row">


        <div class="col-md-1 box-body">

        </div>
        <div class="col-md-10 box-login small">
            <h4>Registrar Usuario</h4>
            <hr>
            <form enctype="multipart/form-data" method="POST" action="" class="col-md-12">
            <div class="row">
              {% csrf_token %}

              <div class="col-md-12">
                <h5 class="text-primary">Datos Personales</h5>
                <div class="row">
                  <div class="col-md-3">
                    <label for="">Nombres:</label>
                    {{ formUsuario.nombres }}
                  </div>
                  <div class="col-md-3">
                    <label for="">Apellido paterno:</label>
                    {{ formUsuario.apellido_paterno }}
                  </div>
                  <div class="col-md-3">
                    <label for="">Apellido materno:</label>
                    {{ formUsuario.apellido_materno }}
                  </div>
                  <div class="col-md-3">
                    <label for="">DNI:</label>
                    {{ formUsuario.dni }}
                  </div>
                </div>

              </div>

              <div class="col-md-12">
                <h5 class="text-primary">Datos de la Cuenta</h5>
                <div class="row">
                  <div class="col-md-3">
                    <label for="">Nombre de usuario:</label>
                    <input type="text" name="username" class="form-control-p" required id="username" placeholder="Nombre de usuario">
                    <div id="mensaje-username"></div>
                  </div>
                  <div class="col-md-3">
                    <label for="email">Dirección de correo electrónico:</label>
                    <input type="email" name="email" class="form-control-p" required placeholder="Dirección de correo electrónico" id="email">
                    <div id="mensaje-email"></div>
                  </div>
                  <div class="col-md-3">
                    <label for="password1">Contraseña:</label>
                    <input type="password" name="password1" class="form-control-p" required placeholder="Contraseña" id="password1">
                  </div>
                  <div class="col-md-3">
                    <label for="password2">Confirmar Contraseña:</label>
                    <input type="password" name="password2" class="form-control-p" required placeholder="Confirmar contraseña" id="password2">
                  </div>
                  <div class="col-md-3">
                    <label for="">Foto de perfil</label>
                    {{ formUsuario.foto_perfil }}
                  </div>
                  <div class="col-md-3">
                    <label for="">Entidad bancaria:</label>
                    {{ formUsuario.entidad_bancaria }}
                  </div>
                  <div class="col-md-3">
                    <label for="">Número de cuenta:</label>
                    {{ formUsuario.numero_cuenta }}
                  </div>
                </div>
              </div>

              <div class="col-md-12">
                <h5 class="text-primary">Datos del Referente</h5>
                <div class="row">
                  <div class="col-md-3">
                    <label for="">Buscar usuario referente:</label>
                    <input type="text" id="busqueda" name="busqueda" class="form-control-p" placeholder="Nombres del referente">
                    <!-- <ul id="resultados-busqueda">
                    </ul> -->

                  </div>

                  <div class="col-md-3">
                    <label for="">DNI del referente:</label>
                    {{ formUsuario.dni_referido }}
                  </div>
                </div>

              </div>

              <div class="col-md-5" id="result-bsqd">
                <!-- <div class="row">
                  <div class="col-md-1" style="border:1px solid red">
                    fotoo
                  </div>
                  <div class="col-md-3" style="border:1px solid red">
                    <p>nombres y apellidos</p>
                    <p>DNI</p>
                  </div>

                </div> -->

              </div>

            </div>
<hr>
              <div class="form-group col-md-12">
                <button id="boton" type="submit" class="btn btn-primary btn-sm" disabled>Guardar</button>
                <a href="{% url 'home:index' %}">Ya tengo una cuenta</a>
              </div>
            </form>

        </div>
    </div>

</div>

<script>
  // // busqueda de Referente
  //   $(function () {
  //       $('#busqueda').keyup(function () {
  //           var txt = $(this).val();
  //           if (txt === '') { }
  //           else {
  //               $.ajax({
  //                   type: "POST",
  //                   url: "/Usuario/buscar-usuario/",
  //                   data: {
  //                       'busqueda': $('#busqueda').val(),
  //                       'csrfmiddlewaretoken': $("input[name=csrfmiddlewaretoken]").val()
  //                   },
  //                   success: searchSuccess,
  //                   dataType: 'html'
  //               });
  //           }
  //       });
  //   });
  //
  //   function searchSuccess(data, textStatus, jqXHR) {
  //       $('#resultados-busqueda').html(data);
  //       $(document).on('click', '#usuario-buscado-dni', function() {
  //         var dni = this.text;
  //         $('#id_dni_referido')[0].value = dni;
  //         });
  //   };

  // busqueda de Referente v2

    $(function () {
        $('#busqueda').on('change',function () {
            var txt = $(this).val();
            if (txt === '') { }
            else {
                $.ajax({
                    type: "POST",
                    url: "/Usuario/buscar-usuario/",
                    data: {
                        'busqueda': $('#busqueda').val(),
                        'csrfmiddlewaretoken': $("input[name=csrfmiddlewaretoken]").val()
                    },
                    success:searchSuccess,
                    dataType: 'json'
                });
            }
        });
    });

    function searchSuccess(data, textStatus, jqXHR) {
      console.log(data);

      $('#result-bsqd').html("")

      for (let i in data) {

        result='<div class="bsqd-card" id="card-'+data[i].pk+'">'+
                '<div class="row">'+
                    '<div class="col-md-4 col-xs-4" style="width: 200px;">'+
                      '<img src="{% static "media/" %}'+data[i].fields.foto_perfil+'" alt="" style="width: 100px; height: 100px;">'+
                    '</div>'+
                    '<div class="col-md-8 col-xs-8">'+
                      '<div class="modal-header-p small">'+
                      '<a onclick="elegirReferente('+data[i].pk+')" class="select-p" style="color:blue">Seleccionar</a><a class="close-p" onclick="removeCard('+data[i].pk+')">x</a>'+
                      '</div>'+
                      '<p><b>'+data[i].fields.nombres+' '+data[i].fields.apellido_paterno+' '+data[i].fields.apellido_materno+'</b></p>'+
                      '<p><b>'+data[i].pk+'</b></p>'+
                    '</div>'+
                 '</div>'+
                '</div>';

        $('#result-bsqd').append(result);
      }

    };

    function removeCard(idCard){
      $("#card-"+idCard).remove();
    }
    function elegirReferente(dni){
      $('#id_dni_referido')[0].value = dni;
      $(".bsqd-card").remove();
    }
// ------------ fin busqueda de Referente v2------------



    // Validación de username
    $(function() {
      $('#username').keyup(function() {
        var txt = $(this).val();
        if (txt === '') { }
        else {
          $.ajax({
            type: "POST",
            url: "/Usuario/validar-username/",
            data: {
              'username': $('#username').val(),
              'csrfmiddlewaretoken': $("input[name=csrfmiddlewaretoken]").val()
            },
            success: validacionUsername,
            dataType: 'html'
          });
        }
      });
    });

    function validacionUsername(data, textStatus, jqXHR) {
      $('#mensaje-username').html(data);
      var msjUsername = $('#mensaje-username')[0].children[0].id;
      if (msjUsername === "msj-username-libre") {
        $('#boton')[0].disabled = false;
      } else {
        $('#boton')[0].disabled = true;
      }
    };

    // Validación de email
    $(function() {
      $('#email').keyup(function() {
        var email = $(this).val();
        if(email === '') { }
        else {
          $.ajax({
            type: "POST",
            url: "/Usuario/validar-email/",
            data: {
              'email': $('#email').val(),
              'csrfmiddlewaretoken': $("input[name=csrfmiddlewaretoken").val()
            },
            success: validacionEmail,
            dataType: 'html'
          });
        }
      });
    });

    function validacionEmail(data, textStatus, jqXHR) {
      $('#mensaje-email').html(data);
      var msjEmail = $('#mensaje-email')[0].children[0].id;
      if (msjEmail === 'msj-email-libre') {
        $('#boton')[0],disabled = false;
      } else {
        $('#boton')[0],disabled = true;
      }
    }

</script>

{% endblock %}
